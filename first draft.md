## 报告初稿（PPt)使用

### 1.简介



### 2.行动简介
+ （1）
+ （2）Snake In The Grass
  这次的情报收集活动主要针对的是巴基斯坦的军事领域，时间是2013年12月底至2014年初。
  这主要是本次攻击行动中的恶意代码大部分是用Python编写的脚本，然后使用PyInstaller 和 Py2Exe两种方式进行打包。相关恶意代码发生了较大的变化，其中出现了由 Python、AutoIt、Go 语言等开发的恶意代码。
  本次攻击主要是用了鱼叉邮件的方式，邮件里面包含诱饵文档和恶意的python安装程序，诱饵文档多伪装为印度军方的相关机密文档，伪装成“pps、doc、pub、pdf、jpg”等类型的文件诱导用户点击，样本程序大多是自解压文件点击后在打开正常文件的同时可以释放并运行恶意程序。恶意的文件主要用 python 编写的脚本然后使用 PyInstaller 和 Py2Exe 两种方式进行打包。
  恶意代码执行的步骤分为一下三步：
  1. 调用系统工具检测虚拟机，上传指定目录下的文件到服务器，从服务器下载文件并执行。
  2. 修改注册表添加启动项
  3. 偷窃格式为““doc, xls, ppt, pps, inp, pdf, xlsx, docx, pptx”的文件。
     除此之外，记录键盘的操作到日记文件中。
  本次攻击行动中可以从C&C服务器等网络行为联系到Hangover的攻击行动。
+ （3）Patchwork
这次攻击主要针对的是东南亚和中国南海，攻击自2015年12月被检测出到2016年7月报告发布，已感染了约2500台电脑，据报告显示活动最早可追溯到2014年。
Patchwork攻击主要针对军事和政治机构，相对其它APT攻击而言，该APT攻击所使用的全部攻击代码都来自于互联网上的开源代码，成本低，但攻击效果强。
通过Cymmetria MazeRunner以蜜罐的方式捕获了攻击者的活动，推测出其攻击流程如下：
首先，向目标发送以pps为附件的网络钓鱼邮件，当用户点击附件时，pps文件播放，触发漏洞，该漏洞为CVE-2014-4114,存在于未打补丁的Office PowerPoint 2013和2017中。漏洞执行，开始攻击，攻击可分为以下两个阶段：
第一阶段，利用编译的Autolt脚本，进行提权操作，与C&C控制器建立连接，扫描文件并上传。提权操作采用UACME方法，获得更高权限后，运行PowerSploit，通过MeterPreter建立远程连接，收集并上传文件。这一阶段的有效载荷是sysvolinfo.exe。
第二阶段，在确定目标价值后，释放恶意软件7zip.exe，执行磁盘文件的扫描、筛选与上传。同时，为了保证长期的控制，7zip.exe复制自身在C:\Windows\SysWOW64\目录下生成netvmon.exe文件，并以自启动服务Net Monitor 运行。
![image](https://github.com/Bessroy/picture/blob/master/patchwork/2018-10-18_001412.png)

图1 Patchwork攻击流程
图2展示了与C&C连接的分析结果

![image](https://github.com/Bessroy/picture/blob/master/patchwork/2018-10-18_001641.png)

图2 Patchwork溯源结果

monsoon（2016——Forcepoint）
此次攻击开始于2015年12月，再2016年5月开始被检测出，到2019年7月仍然在进行攻击。Monsoon攻击被与Operation Hangover联系到一起，因为有相同的基础设施和攻击目标。
此次攻击主要利用了钓鱼邮件投放恶意文档，包含的恶意软件有Unknown Logger，TINYTYPHON, BADNEWS和AutoIt的一个后门。通过对样本分析，其攻击流程为
![image](https://github.com/JerryTang1996/nothing/blob/master/monsoon.png)
其中利用的主要恶意软件被命名为BADNEWS，BADNEWS恶意软件是第一阶段恶意软件，如果目标感兴趣的话，很可能接收第二阶段恶意软件组件，但没有观察到这种行为。通过dll-sideloading 引出三个文件MicroScMgmt.exe ，msvcr71.dll ，jli.dll
用合法的MICSCMGMT.EXE（Sun Microsystems签名）运行时加载恶意jli.dll，BADNEWS此时开始执行恶意代码，这样可以绕过恶意软件检测。恶意软件将产生2个线程，一个执行关键日志记录，一个扫描本地硬盘驱动器。
BADNEWS同时安装一个注册表项来保持其持续性，有几个硬编码（给变量附固定值）的C＆C通道，C&C地址在blog中通过搜索’{{‘来获取，是一段加密的C&C地址。

+ （4）Indian Subcontinent Attack (2018.7)
    这次攻击主要针对巴基斯坦的军事和核能领域。Patchwork团队利用CVE-2015-2545、CVE-2017-0261漏洞，以涉及巴基斯坦军事升级、原子能委员会等主题的恶意文档作为诱饵，传播BADNEWS有效载荷。
    BADNEWS恶意软件充当攻击者的后门，为他们提供对受害者机器的完全控制，其利用合法的第三方网站来托管恶意软件的命令和控制信息，如下载和执行附加信息、上传感兴趣的文档以及获取桌面截图等。收集信息后，BADNEWS利用HTTP与远程服务器进行通信。

+ （5）对美国智库的攻击（2018年3月~4月）

    此次攻击中最值得注意的地方是Patchwork调整了攻击的目标，直接对美国智库发起攻击。此外，在这次攻击中，Patchwork除了发送恶意软件诱饵，该组织还在邮件中通过一个特定于每一个接收者的唯一跟踪链接，来识别哪一个接收到该邮件的人点开了恶意信息。

    **钓鱼邮件的发送**：钓鱼邮件都发送自攻击者控制的域名：mailcenter.support. 这个域名不仅用于发送钓鱼邮件，还用于跟踪打开了电子邮件的目标。攻击者通过在邮件中模仿美国知名的智库的域名或邮件主题来诱使收件人点开链接。在邮件的HTML格式的消息中，一个嵌入的图片tag包含了攻击者的域名和一个用于跟踪收件人的32字节标识符。

    **漏洞利用和恶意软件执行**：当被攻击目标点开包含恶意文档的链接，攻击者会利用“packager trick”来把初始的QuasarRAT dropper（qrat.exe）嵌入到RTF文档中（QuasarRAT是一个用C#编写的远程管理/访问工具，包含文件管理、上传、下载和执行、键盘记录、远程控制和反向代理等功能）。然后攻击者会利用CVE-2017-8570漏洞执行嵌入到RTF文档中的恶意脚本（”scriptlet“或.sct文件）。这个脚本启动qrat.exe，这个程序在`C:\Users\%username%\AppData\Roaming\Microsoft Network\microsoft_network\1.0.0.0`中创建一个目录，并且把最终用于攻击的二进制文件microsoft_network.exe放入其中。恶意软件还包含了一个名为Microsoft.Win32.TaskScheduler.dll的文件，用于操作系统上的任务调度。这个文件由AirVPN的数字证书进行签名。

    在恶意软件执行的时候QuasarRAT的调度任务被命名为Microsoft_Security_Task，每天凌晨12点运行。一旦进程被触发，它每五分钟运行一次，重复60天。执行时，microsoft_network.exe将向freegeoip.net发起请求，以确定受感染主机的地理位置。 在请求之后，恶意软件将立即与在攻击者控制下的域名 tautiaos.com（43.249.37.199）建立加密连接。

    整个样本执行流程如下：

    ![](https://i.imgur.com/iiwWHyY.jpg)

    **总结**：这次对美国智库的攻击体现了Patchwork的攻击目标在地理位置上的多样性。攻击者在钓鱼邮件中除了包含恶意软件之外，还是用特定于攻击者的唯一链接来跟踪目标是否被成功攻击，可以使之后的攻击更高效地进行。此外攻击者在这次攻击中使用了开源的RAT，使其可以灵活地与被攻击机器进行交互而无需使用自定义的恶意软件。


### 3.溯源的技术与流程
#### 3.1攻击主机的溯源取证
+ Patchwork：通过MazeRunner，研究人员可以及时知道网络动态，当攻击者发现网络并开始使用时，研究人员收到提醒并捕获到黑客的所有工具，进而可执行反编译等操作。通过MeterPreter的连接，可看出攻击主机的IP地址为45[.]43.192.172，端口号8443。

+ Monsoon（2016）：将截取的样本上传到Virus Total上进行分析，在此次攻击投放的RTF文档中发现修改文档的用户，对该作者进行VT搜索，找到了6个相关文件，并且这六个文件大小相同，利用同一个漏洞，很大可能来自于同一个人。
VT结果显示该文件是从IP地址37.58.60.195主机上WEB服务器提供的，该服务器还提供了其他类似的文件。
37.58.60.195 的地址是比利时的一个合法的邮件服务网站，YMLP公司。其他的恶意文档也指向YMLP。
利用YMLP，攻击者将恶意文档放在邮件中，并进行攻击。

#### 3.2 控制主机溯源取证
+ Patchwork：攻击者通过MeterPreter与攻击主机的通信，将文件内容上传至C&C控制主机，经监测，第一阶段的控制主机IP为212[.]129.13.110，第二阶段尝试对话的主机IP为212[.]83.191.156，遗憾的是，攻击方并没有成功进行第二阶段攻击。

+ Monsoon：Monsoon中的恶意代码在获取C&C地址的时候，相关C&C地址并未预留在恶意代码本身，而是存放在第三方可信网站中。
在第三方可信网站或论坛中预留C&C地址，如在github中
 ![image](https://github.com/JerryTang1996/nothing/blob/master/C%26C%201.png)
某论坛：
![image](https://github.com/JerryTang1996/nothing/blob/master/C%26C%202.png)
“{{“之后的内容就是加密后的C&C地址，但是该内容在原论坛中是看不到的，因为攻击者用白底白字进行评论。
进行解密之后，得到的C&C地址是http://5.254.98.68/mtzpncw/gate.php

+ 使用360威胁情报中心数据平台搜索一下其中一个C&C IP地址：94.242.249.206，可以看到相关IP已经被打上摩诃草的标签，这表明该IP曾经被摩诃草做为网络基础设施使用过：![](https://i.imgur.com/nJc4Zwd.png)

#### 3.3 攻击者以及攻击组织溯源取证
+ Snake In The Grass：提取恶意代码的脚本之后，可以发现它与2013年的Hangover攻击使用的是相同的 C&C 服务器。同时在部分AutoIT的恶意程序中，HTTP请求与Hangover攻击中的HTTP请求格式相同。因此两者的网络构建是相关联的。所以说本次攻击与Hangover攻击是同一个组织。
+ Patchwork：通过控制一台C&C控制主机，研究人员获取了大量的恶意代码和PPS文件，发现了攻击时间、域名注册等时间和PPS文件最后编辑时间具有一致性，进而判断出攻击者所处的时区；再根据APT攻击的意图、需求以及钓鱼软件的内容，判断攻击者与印度有关。
+ Monsoon:攻击者：可以通过几点来确定谁参与到了Monsoon活动中
	1.	域名注册方式与Monsoon的注册方式类似
	2.	域名的注册者生活在印度
	3.	注册该域名的人在开源的代码交流论团上有留下了个人信息

#### 3. 4 攻击组织刻画
##### 3. 4. 2 组织来源地域
+ Snake In The Grass：印度地区
+ Patchwork：印度或亲印地区
+ Monsoon(2016):Monsoon被匹配到印度拥有军事和政治力量的群体。许多受害者都在周边国家，包括孟加拉，斯里兰卡和巴基斯坦。但受害者也可能在更远的地方，包括非洲和远东地区。针对中国公民的攻击可能也与此组织，但同样也可能是对手单独活动的一部分，或者甚至作为他们以以前在HANGOVER集团中看到的类似活动的一部分。
##### 3. 4. 3组织主要目标及意图
Snake In The Grass：巴基斯坦地区，窃取军事方面的情报。
Patchwork：东南亚及中国南海，窃取军事、政治情报。

Monsoon：中国，巴基斯坦，印度周围地区。

2018年出现了针对美国智库组织的攻击，意图包括收集文件、键盘记录和下载执行。
##### 3. 4. 4组织攻击方法

| 攻击方法 | 攻击载体               | 攻击描述                                                     |
| -------- | ---------------------- | ------------------------------------------------------------ |
| 钓鱼攻击 | 鱼叉邮件               | 主要使用了python编写的脚本，通过PyInstaller 和 Py2Exe 两种打包方式将其打包成 exe 程序。利用CxsSvce.exe,send.exe调用系统工具systeminfo.exe 检测虚拟机，上传指定目录下的文件到服务器，从服务器下载文件并执行；使用reg.exe，reg1.exe修改注册表添加启动项、winrm.exe，stisvc.exe偷窃文件，同时，使用sppsvc.exe，key.exe记录键盘活动。 |
| 钓鱼攻击 | 包含恶意代码的邮件附件 | Patchwork利用CVE-2014-4114漏洞，释放inf文件，执行Autolt脚本，首先通过sysvolinfo.exe进行提权并与攻击主机互联，向C&C控制主机上传文件，若有价值则释放7zip.exe，将其重命名隐藏在特定文件夹内，并设置为开机自启动，持续不断向控制主机上传内容。 |


